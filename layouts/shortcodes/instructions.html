{{/*
    Instructions shortcode - extracts steps for schema.org and outputs normal HTML

    Usage (numbered list):
    {{< instructions >}}
    1. Mix ingredients
    2. Bake at 350°F
    {{< /instructions >}}

    Usage (prose with bold headers):
    {{< instructions >}}
    **Step 1:** Mix ingredients...
    **Step 2:** Bake at 350°F...
    {{< /instructions >}}
*/}}

{{- $content := .Inner | strings.TrimSpace -}}
{{- $lines := split $content "\n" -}}
{{- $instructions := slice -}}
{{- $currentParagraph := "" -}}

{{/* Parse numbered lists, prose paragraphs with bold headers, or plain paragraphs */}}
{{- range $lines -}}
    {{- $line := strings.TrimSpace . -}}

    {{/* Skip empty lines, shortcodes, headings, and HTML fragments */}}
    {{- if and (ne $line "") (not (hasPrefix $line "#")) (not (hasPrefix $line "{{")) (not (hasPrefix $line "<")) (not (hasPrefix $line "alt=")) -}}

        {{/* Numbered list item (1. 2. 3. etc) */}}
        {{- if findRE `^\d+\.\s+` $line -}}
            {{- if ne $currentParagraph "" -}}
                {{- $instructions = $instructions | append $currentParagraph -}}
                {{- $currentParagraph = "" -}}
            {{- end -}}
            {{- $instruction := replaceRE `^\d+\.\s+` "" $line -}}
            {{- $instructions = $instructions | append $instruction -}}

        {{/* Paragraph starting with bold (e.g., "**Prep:**" or "**Step 1:**") */}}
        {{- else if hasPrefix $line "**" -}}
            {{- if ne $currentParagraph "" -}}
                {{- $instructions = $instructions | append $currentParagraph -}}
            {{- end -}}
            {{- $currentParagraph = $line -}}

        {{/* Continuation of current paragraph */}}
        {{- else if ne $currentParagraph "" -}}
            {{- $currentParagraph = printf "%s %s" $currentParagraph $line -}}

        {{/* Standalone paragraph (no bold header) */}}
        {{- else -}}
            {{- $instructions = $instructions | append $line -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{/* Append last paragraph if exists */}}
{{- if ne $currentParagraph "" -}}
    {{- $instructions = $instructions | append $currentParagraph -}}
{{- end -}}

{{/* Store in Page.Scratch for schema.html to read */}}
{{- .Page.Scratch.Set "instructions" $instructions -}}

{{/* Output normal HTML */}}
{{- .Inner | markdownify -}}
